<% layout('layout') -%>

<h3>Numbers</h3>

<div class="mb-3 d-flex gap-2">
  <a class="btn btn-outline-secondary" href="/admin/numbers/export?format=csv">Export CSV</a>
  <a class="btn btn-outline-secondary" href="/admin/numbers/export?format=xlsx">Export XLSX</a>
  <a class="btn btn-outline-primary ms-auto" href="/admin/users">Users & Files</a>
</div>

<form method="get" action="/admin/numbers" class="mb-3 d-flex gap-2">
  <input type="text" name="search" class="form-control" placeholder="Search by phone or added_by" value="<%= search || '' %>">
  <button class="btn btn-primary">Search</button>
</form>

<table class="table table-striped table-hover">
  <thead>
    <tr><th>ID</th><th>Phone</th><th>Added By</th><th>Created</th><th></th></tr>
  </thead>
  <tbody>
    <% rows.forEach(r => { %>
    <tr>
      <td><%= r.id %></td>
      <td><code><%= r.phone %></code></td>
      <td><%= r.added_by || '-' %></td>
      <td><%= new Date(r.created_at).toLocaleString() %></td>
      <td>
        <form method="post" action="/admin/numbers/<%= r.id %>/delete?_method=POST" onsubmit="return confirm('Delete?')">
          <button class="btn btn-sm btn-danger">Delete</button>
        </form>
      </td>
    </tr>
    <% }) %>
  </tbody>
</table>

<nav>
  <ul class="pagination">
    <% if (page > 1) { %>
      <li class="page-item">
        <a class="page-link" href="?page=<%= page - 1 %>&search=<%= search || '' %>">Previous</a>
      </li>
    <% } else { %>
      <li class="page-item disabled"><span class="page-link">Previous</span></li>
    <% } %>

    <%
      const totalPages = pages;
      const currentPage = page;
      const visibleAround = 4; // 9 total = 4 before + current + 4 after
      const startPage = Math.max(1, currentPage - visibleAround);
      const endPage = Math.min(totalPages, currentPage + visibleAround);

      // Always show last 5 pages
      const lastPagesStart = Math.max(totalPages - 4, 1);
    %>

    <% if (startPage > 1) { %>
      <li class="page-item"><a class="page-link" href="?page=1&search=<%= search || '' %>">1</a></li>
      <% if (startPage > 2) { %>
        <li class="page-item disabled"><span class="page-link">...</span></li>
      <% } %>
    <% } %>

    <% for (let i = startPage; i <= endPage && i < lastPagesStart; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a class="page-link" href="?page=<%= i %>&search=<%= search || '' %>"><%= i %></a>
      </li>
    <% } %>

    <% if (endPage < lastPagesStart - 1) { %>
      <li class="page-item disabled"><span class="page-link">...</span></li>
    <% } %>

    <% for (let i = lastPagesStart; i <= totalPages; i++) { %>
      <li class="page-item <%= i === currentPage ? 'active' : '' %>">
        <a class="page-link" href="?page=<%= i %>&search=<%= search || '' %>"><%= i %></a>
      </li>
    <% } %>

    <% if (page < pages) { %>
      <li class="page-item">
        <a class="page-link" href="?page=<%= page + 1 %>&search=<%= search || '' %>">Next</a>
      </li>
    <% } else { %>
      <li class="page-item disabled"><span class="page-link">Next</span></li>
    <% } %>
  </ul>
</nav>
